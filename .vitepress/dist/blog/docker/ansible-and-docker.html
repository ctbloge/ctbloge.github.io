<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用 Ansible 工具批量操作虚拟机集群，自动化安装 Docker | 川塔文档</title>
    <meta name="description" content="A VitePress Site">
    <meta name="generator" content="VitePress v1.6.3">
    <link rel="preload stylesheet" href="/assets/style.CwNnKCVM.css" as="style">
    <link rel="preload stylesheet" href="/vp-icons.css" as="style">
    
    <script type="module" src="/assets/app.BoO6kStU.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/theme.LynrPoBR.js">
    <link rel="modulepreload" href="/assets/chunks/framework.CDhRSyRB.js">
    <link rel="modulepreload" href="/assets/blog_docker_ansible-and-docker.md.DuJ5IkC2.lean.js">
    <link rel="icon" href="/img/favicon.png">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-d8b57b2d><!--[--><!--]--><!--[--><span tabindex="-1" data-v-fcbfc0e0></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-fcbfc0e0>Skip to content</a><!--]--><!----><header class="VPNav" data-v-d8b57b2d data-v-7ad780c2><div class="VPNavBar" data-v-7ad780c2 data-v-9fd4d1dd><div class="wrapper" data-v-9fd4d1dd><div class="container" data-v-9fd4d1dd><div class="title" data-v-9fd4d1dd><div class="VPNavBarTitle has-sidebar" data-v-9fd4d1dd data-v-9f43907a><a class="title" href="/" data-v-9f43907a><!--[--><!--]--><!----><span data-v-9f43907a>川塔文档</span><!--[--><!--]--></a></div></div><div class="content" data-v-9fd4d1dd><div class="content-body" data-v-9fd4d1dd><!--[--><!--]--><div class="VPNavBarSearch search" data-v-9fd4d1dd><!--[--><!----><div id="docsearch"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-9fd4d1dd data-v-afb2845e><span id="main-nav-aria-label" class="visually-hidden" data-v-afb2845e> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" tabindex="0" data-v-afb2845e data-v-815115f5><!--[--><span data-v-815115f5>Home</span><!--]--></a><!--]--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="https://www.ctbloge.top" target="_blank" rel="noreferrer" tabindex="0" data-v-afb2845e data-v-815115f5><!--[--><span data-v-815115f5>个人博客</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-9fd4d1dd data-v-3f90c1a5><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-3f90c1a5 data-v-be9742d9 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-be9742d9></span><span class="vpi-moon moon" data-v-be9742d9></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-9fd4d1dd data-v-ef6192dc data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/ctbloge/ctbloge.github.io" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-60a9a2d3><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-9fd4d1dd data-v-f953d92f data-v-bfe7971f><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-bfe7971f><span class="vpi-more-horizontal icon" data-v-bfe7971f></span></button><div class="menu" data-v-bfe7971f><div class="VPMenu" data-v-bfe7971f data-v-20ed86d6><!----><!--[--><!--[--><!----><div class="group" data-v-f953d92f><div class="item appearance" data-v-f953d92f><p class="label" data-v-f953d92f>Appearance</p><div class="appearance-action" data-v-f953d92f><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-f953d92f data-v-be9742d9 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-be9742d9></span><span class="vpi-moon moon" data-v-be9742d9></span><!--]--></span></span></button></div></div></div><div class="group" data-v-f953d92f><div class="item social-links" data-v-f953d92f><div class="VPSocialLinks social-links-list" data-v-f953d92f data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/ctbloge/ctbloge.github.io" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-60a9a2d3><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-9fd4d1dd data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><div class="divider" data-v-9fd4d1dd><div class="divider-line" data-v-9fd4d1dd></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-d8b57b2d data-v-2488c25a><div class="container" data-v-2488c25a><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-2488c25a><span class="vpi-align-left menu-icon" data-v-2488c25a></span><span class="menu-text" data-v-2488c25a>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-2488c25a data-v-6b867909><button data-v-6b867909>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-d8b57b2d data-v-42c4c606><div class="curtain" data-v-42c4c606></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-42c4c606><span class="visually-hidden" id="sidebar-aria-label" data-v-42c4c606> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-51288d80><section class="VPSidebarItem level-0 collapsible has-active" data-v-51288d80 data-v-0009425e><div class="item" role="button" tabindex="0" data-v-0009425e><div class="indicator" data-v-0009425e></div><h2 class="text" data-v-0009425e>安装部署</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-0009425e><span class="vpi-chevron-right caret-icon" data-v-0009425e></span></div></div><div class="items" data-v-0009425e><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/blog/docker/install-docker.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>容器化部署博客（Django）—— 安装 docker 和 docker-compose</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/blog/docker/ansible-and-docker.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>使用 Ansible 工具批量操作虚拟机集群，自动化安装 Docker</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-51288d80><section class="VPSidebarItem level-0 collapsible" data-v-51288d80 data-v-0009425e><div class="item" role="button" tabindex="0" data-v-0009425e><div class="indicator" data-v-0009425e></div><h2 class="text" data-v-0009425e>镜像操作</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-0009425e><span class="vpi-chevron-right caret-icon" data-v-0009425e></span></div></div><div class="items" data-v-0009425e><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/blog/docker/docker-image-for-django.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>分享一个给 Django 镜像瘦身 50% 的经验</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/blog/docker/dockerfile-multi-stage.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>Dockerfile 中的 multi-stage 特性，Vue 项目多阶段构建实战</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-d8b57b2d data-v-9a6c75ad><div class="VPDoc has-sidebar has-aside" data-v-9a6c75ad data-v-e6f2a212><!--[--><!--]--><div class="container" data-v-e6f2a212><div class="aside" data-v-e6f2a212><div class="aside-curtain" data-v-e6f2a212></div><div class="aside-container" data-v-e6f2a212><div class="aside-content" data-v-e6f2a212><div class="VPDocAside" data-v-e6f2a212 data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-cb998dce data-v-f610f197><div class="content" data-v-f610f197><div class="outline-marker" data-v-f610f197></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-f610f197>On this page</div><ul class="VPDocOutlineItem root" data-v-f610f197 data-v-53c99d69><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-e6f2a212><div class="content-container" data-v-e6f2a212><!--[--><!--]--><main class="main" data-v-e6f2a212><div style="position:relative;" class="vp-doc _blog_docker_ansible-and-docker" data-v-e6f2a212><div><h1 id="使用-ansible-工具批量操作虚拟机集群-自动化安装-docker" tabindex="-1">使用 Ansible 工具批量操作虚拟机集群，自动化安装 Docker <a class="header-anchor" href="#使用-ansible-工具批量操作虚拟机集群-自动化安装-docker" aria-label="Permalink to &quot;使用 Ansible 工具批量操作虚拟机集群，自动化安装 Docker&quot;">​</a></h1><p>ansible 是一个 Python 写的自动化工具，这个工具可以实现集群自动化管理，然后进行一些常用的运维操作。现在的公司很多都是使用的集群部署服务，少则几台虚拟机，多则几百上千台虚拟机，有的时候需要对一个集群或者多个集群集中进行运维操作，那么这个时候，ansible 就可以实现批量操作了。</p><p>我在公司主要负责的任务就是关于服务的自动化部署和运维，公司本身就属于云服务，而且非常多，所以部署的方式也有很多种版本，我接触到的自动化平台主要包括一下几种：</p><ol><li>以 ansible 脚本为主导而搭建的自动化部署升级平台</li><li>以类似 Jenkins 流水线而搭建的自动化构建和部署平台</li><li>以 SDK 包为基础，以 Python 脚本执行主导的运维平台</li><li>docker 容器+编排</li></ol><p>这篇文章分享一下使用 ansible 自动化安装 docker 和 docker-compose 的经验。</p><h2 id="安装ansible" tabindex="-1">安装ansible <a class="header-anchor" href="#安装ansible" aria-label="Permalink to &quot;安装ansible&quot;">​</a></h2><p>ansible 的管理机必须安装 python2，但是有个非常重要的点，那就是 Windows 不可以当做管理机，主机系统可以是 Red Hat, Debian, CentOS, OS X, BSD 的各种版本。</p><h3 id="使用pip安装" tabindex="-1">使用pip安装 <a class="header-anchor" href="#使用pip安装" aria-label="Permalink to &quot;使用pip安装&quot;">​</a></h3><p>由于 ansible 是一个 python 写的包，所以可以直接当做一个普通的第三方库来安装，直接运行命令安装即可:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible</span></span></code></pre></div><h3 id="使用yum或者apt-get安装" tabindex="-1">使用yum或者apt-get安装 <a class="header-anchor" href="#使用yum或者apt-get安装" aria-label="Permalink to &quot;使用yum或者apt-get安装&quot;">​</a></h3><p>ansible 也可以直接使用系统的包管理工具来安装，比如 CentOS 的 yum 命令：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> yum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible</span></span></code></pre></div><p>Ubuntu 系统的 apt-get 命令：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> software-properties-common</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt-add-repository</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ppa:ansible/ansible</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ansible</span></span></code></pre></div><h2 id="ansible基本用法" tabindex="-1">ansible基本用法 <a class="header-anchor" href="#ansible基本用法" aria-label="Permalink to &quot;ansible基本用法&quot;">​</a></h2><h3 id="使用-ansible-playbook" tabindex="-1">使用 ansible-playbook <a class="header-anchor" href="#使用-ansible-playbook" aria-label="Permalink to &quot;使用 ansible-playbook&quot;">​</a></h3><p>ansible-playbook 也称之为剧本，是 ansible 把一系列自动化操作按照一定的执行顺序和执行逻辑进行组合起来的模块，使用这个模块可以更加方便地管理 ansible 任务。</p><p>ansible-playbook 命令可以作为运行一个 ansible 任务的开始，具体如何使用，可以查看帮助，下面这条是一般启动命令：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ansible-playbook</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker.yml</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> hosts</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -u</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> alex</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -k</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -K</span></span></code></pre></div><p>这个命令可以指定一个操作的用户，后续需要输入用户的密码和sudo命令。</p><p>由于 ansible 有很多非常有用的模块和命令可以使用，但是没有人能够全部记住每个模块命令，但是 ansible 有一个非常有用的命令使用查询文档，直接使用命令就可以查看某个模块的用法，还有例子：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 列出所有模块</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ansible-doc</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -l</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 列出yum模块的使用方式</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ansible-doc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> yum</span></span></code></pre></div><h3 id="ansible-playbook-目录结构" tabindex="-1">ansible-playbook 目录结构 <a class="header-anchor" href="#ansible-playbook-目录结构" aria-label="Permalink to &quot;ansible-playbook 目录结构&quot;">​</a></h3><p>下面是一个 ansible-playbook 项目的基本目录结构，具体的目录和文件作用已经注释出来：</p><div class="language-markdown vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">markdown</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">├── group_vars           &lt;- 所有主机的公共变量存放位置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   └── all</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">├── hosts                &lt;- 需要管理的主机的列表信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">├── roles              &lt;- roles 存放模块, 当前有 etcd, initial, loop 三个模块</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   ├── etcd</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   ├── files                    &lt;- 需要直接复制到 client 的文件存放位置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   │   └── etcd-proxy.service            &lt;--即每个主机配置一样</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   ├── handlers                     &lt;- 用于服务管理用的控制文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   │   └── main.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   ├── tasks                        &lt;- ansible 任务文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   │   ├── config.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   │   ├── main.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   │   ├── package.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   │   └── service.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   └── templates                &lt;- 需要复制到 client 中的模板文件, 会配合变量进行配置变换</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │       └── etcd-proxy.conf       &lt;-- 即每个主机配置可能不一样</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   ├── initial</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   ├── files</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   │   ├── hosts</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   │   ├── resolv.conf</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   │   └── updatedb.conf</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   ├── handlers</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   ├── tasks</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   │   ├── main.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   │   ├── mlocate.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   │   ├── package.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   │   ├── sysctl.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   │   └── yumrepo.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │   └── templates</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │       ├── centos7.repo</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   │       └── docker.repo</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│   └── loop</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│       ├── files</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│       ├── handlers</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│       ├── tasks</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│       │   ├── main.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│       │   └── t1.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">│       └── templates</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">└── site.yml                           &lt;- 主控制入口文件</span></span></code></pre></div><h2 id="ansible-安装-docker" tabindex="-1">ansible 安装 docker <a class="header-anchor" href="#ansible-安装-docker" aria-label="Permalink to &quot;ansible 安装 docker&quot;">​</a></h2><p>我写了一个使用 ansible 自动化安装 docker 的剧本（项目地址：<a href="https://github.com/Hopetree/ansible-demos/tree/master/install_docker" target="_blank" rel="noreferrer">https://github.com/Hopetree/ansible-demos/tree/master/install_docker</a>），适合于在 CentOS 系统上面执行 docker 的安装。这个剧本做的事情包括判断 docker 是否可以用，然后包括安装 docker，添加用户到 docker 组，安装pip 和 docker-compose 等。剧本目录如下：</p><div class="language-markdown vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">markdown</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+----docker.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+----group_vars</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">|    +----all.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+----hosts</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">+----roles</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">|    +----docker</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">|    |    +----tasks</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">|    |    |    +----install.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">|    |    |    +----main.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">|    |    +----templates</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">|    |    |    +----daemon.json.j2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">|    +----docker-compose</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">|    |    +----tasks</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">|    |    |    +----install_pip.yml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">|    |    |    +----main.yml</span></span></code></pre></div><h3 id="尽量使用内置模块" tabindex="-1">尽量使用内置模块 <a class="header-anchor" href="#尽量使用内置模块" aria-label="Permalink to &quot;尽量使用内置模块&quot;">​</a></h3><p>所谓尽量使用内置模块的意思是当可以使用 shell 模块执行命令也可以使用内置的模块执行命令的时候应该尽量使用内置模块，比如下面这种，前面一种是使用命令行来安装包，后面一种是直接使用 yum 模块：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 使用shell 命令行安装</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">install yum-utils</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  shell</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">yum install yum-utils</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 使用yum 模块安装</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">install yum-utils</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  yum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">yum-utils</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    state</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">present</span></span></code></pre></div><p>还有下面这种直接使用pip模块的：</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">install docker-compose</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  pip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">docker-compose</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    extra_args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-i {{ pip.index_url }} --trusted-host {{ pip.trusted_host }}&quot;</span></span></code></pre></div><h3 id="register-when的使用" tabindex="-1">register+when的使用 <a class="header-anchor" href="#register-when的使用" aria-label="Permalink to &quot;register+when的使用&quot;">​</a></h3><p>register 可以用来把一个步骤的执行结果赋值到一个变量中，而 when 就可以用来判断一个变量的结果，所以通常可以把这两个模块结合起来使用。比如下面这段，第一个步骤是使用 <code>docker -v</code> 命令查询 docker 版本，然后第二个步骤判断当 docker 不可用的时候就执行 docker 安装。</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">check docker</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  shell</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">docker -v</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  register</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">result</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  ignore_errors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">True</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">- </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">include tasks yaml if not docker</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  include_tasks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">install.yml</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  when</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">result is failed</span></span></code></pre></div><h3 id="执行结果" tabindex="-1">执行结果 <a class="header-anchor" href="#执行结果" aria-label="Permalink to &quot;执行结果&quot;">​</a></h3><p><img src="https://cdn.jsdelivr.net/gh/Hopetree/blog-img@main/article/190913/tendcode_2019-09-13_22-36-51.png" alt="执行结果"></p><p><img src="https://cdn.jsdelivr.net/gh/Hopetree/blog-img@main/article/190913/tendcode_2019-09-13_22-37-16.png" alt="执行结果"></p></div></div></main><footer class="VPDocFooter" data-v-e6f2a212 data-v-1bcd8184><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-1bcd8184><span class="visually-hidden" id="doc-footer-aria-label" data-v-1bcd8184>Pager</span><div class="pager" data-v-1bcd8184><a class="VPLink link pager-link prev" href="/blog/docker/install-docker.html" data-v-1bcd8184><!--[--><span class="desc" data-v-1bcd8184>Previous page</span><span class="title" data-v-1bcd8184>容器化部署博客（Django）—— 安装 docker 和 docker-compose</span><!--]--></a></div><div class="pager" data-v-1bcd8184><a class="VPLink link pager-link next" href="/blog/docker/docker-image-for-django.html" data-v-1bcd8184><!--[--><span class="desc" data-v-1bcd8184>Next page</span><span class="title" data-v-1bcd8184>分享一个给 Django 镜像瘦身 50% 的经验</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"blog_django_asyncio-task.md\":\"BjVUj3au\",\"blog_django_blog-sync-to-vitepress.md\":\"BONLAEr5\",\"blog_django_django-celery-tasks.md\":\"CndKx28l\",\"blog_django_django-celery.md\":\"DhBwgXxd\",\"blog_django_echarts-for-web.md\":\"CaBKZ_pg\",\"blog_django_index.md\":\"BWwSznhL\",\"blog_django_python-markdown-extensions.md\":\"DCaQO3NT\",\"blog_django_run-celery-task-now.md\":\"m58U6vac\",\"blog_django_task-for-script.md\":\"DrFw_UH9\",\"blog_docker_ansible-and-docker.md\":\"DuJ5IkC2\",\"blog_docker_docker-image-for-django.md\":\"BoVli6bg\",\"blog_docker_dockerfile-multi-stage.md\":\"C1TUtMvo\",\"blog_docker_index.md\":\"e64ZBHh6\",\"blog_docker_install-docker.md\":\"DbKn5IvE\",\"blog_free_index.md\":\"Cl1yoFhq\",\"blog_git_git-commit.md\":\"CdxHTz6Z\",\"blog_git_git-note.md\":\"D-5KtFOZ\",\"blog_git_github-actions.md\":\"BTLZ_UBj\",\"blog_git_index.md\":\"DKU03HF0\",\"blog_git_install-gitea.md\":\"CfIJt4JL\",\"blog_linux_index.md\":\"BYZK6uPA\",\"blog_nginx_index.md\":\"_LkY0Nvh\",\"blog_nginx_nginx-location.md\":\"iNz6H8Qw\",\"blog_nginx_nginx-server.md\":\"Dv3ymfF3\",\"blog_personal-notes_index.md\":\"BOFpx5w-\",\"blog_python_appium-env.md\":\"DjbqN6MT\",\"blog_python_index.md\":\"DMaRQAo1\",\"blog_python_virtualenv-for-python.md\":\"CDfBlA3l\",\"blog_redis_index.md\":\"BQBEqS98\",\"blog_redis_redis-install-sentinel.md\":\"Bwj1_Ro-\",\"blog_redis_redis-install.md\":\"CKpCJruR\",\"index.md\":\"DPRYVxXg\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"川塔文档\",\"description\":\"A VitePress Site\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"search\":{\"provider\":\"algolia\",\"options\":{\"appId\":\"G6QEK9X4WI\",\"apiKey\":\"3be5076322e981f21c813f400e7c8ffd\",\"indexName\":\"hopetreeio\",\"locales\":{\"zh\":{\"placeholder\":\"搜索文档\",\"translations\":{\"button\":{\"buttonText\":\"搜索文档\",\"buttonAriaLabel\":\"搜索文档\"},\"modal\":{\"searchBox\":{\"resetButtonTitle\":\"清除查询条件\",\"resetButtonAriaLabel\":\"清除查询条件\",\"cancelButtonText\":\"取消\",\"cancelButtonAriaLabel\":\"取消\"},\"startScreen\":{\"recentSearchesTitle\":\"搜索历史\",\"noRecentSearchesText\":\"没有搜索历史\",\"saveRecentSearchButtonTitle\":\"保存至搜索历史\",\"removeRecentSearchButtonTitle\":\"从搜索历史中移除\",\"favoriteSearchesTitle\":\"收藏\",\"removeFavoriteSearchButtonTitle\":\"从收藏中移除\"},\"errorScreen\":{\"titleText\":\"无法获取结果\",\"helpText\":\"你可能需要检查你的网络连接\"},\"footer\":{\"selectText\":\"选择\",\"navigateText\":\"切换\",\"closeText\":\"关闭\",\"searchByText\":\"搜索提供者\"},\"noResultsScreen\":{\"noResultsText\":\"无法找到相关结果\",\"suggestedQueryText\":\"你可以尝试查询\",\"reportMissingResultsText\":\"你认为该查询应该有结果？\",\"reportMissingResultsLinkText\":\"点击反馈\"}}}}}}},\"outline\":{\"level\":[2,4]},\"nav\":[{\"text\":\"Home\",\"link\":\"/\"},{\"text\":\"个人博客\",\"link\":\"https://www.ctbloge.top\"}],\"sidebar\":{\"/blog/Django/\":[{\"text\":\"安装部署\",\"collapsed\":false,\"items\":[]},{\"text\":\"定时任务\",\"collapsed\":false,\"items\":[{\"text\":\"Django使用Celery实现异步和定时任务功能\",\"link\":\"/blog/Django/django-celery\"},{\"text\":\"让定时任务支持执行自定义脚本\",\"link\":\"/blog/Django/task-for-script\"},{\"text\":\"把 Celery 定时任务变成实时触发的任务\",\"link\":\"/blog/Django/run-celery-task-now\"},{\"text\":\"使用 Python 的异步模块 asyncio 改造 I/O 密集型定时任务\",\"link\":\"/blog/Django/asyncio-task\"},{\"text\":\"Django博客网站可以用定时任务做些什么事？\",\"link\":\"/blog/Django/django-celery-tasks\"}]},{\"text\":\"可视化\",\"collapsed\":false,\"items\":[{\"text\":\"用 ECharts 做网站数据统计报表，告别第三方流量统计平台\",\"link\":\"/blog/Django/ECharts-for-web\"}]},{\"text\":\"灾备方案\",\"collapsed\":false,\"items\":[{\"text\":\"博客灾备方案（2）：博客文章同步到VitePress静态站\",\"link\":\"/blog/Django/blog-sync-to-vitepress\"}]},{\"text\":\"拓展\",\"collapsed\":false,\"items\":[{\"text\":\"Python-Markdown 自定义拓展\",\"link\":\"/blog/Django/python-markdown-extensions\"}]}],\"/blog/docker/\":[{\"text\":\"安装部署\",\"collapsed\":false,\"items\":[{\"text\":\"容器化部署博客（Django）—— 安装 docker 和 docker-compose\",\"link\":\"/blog/docker/install-docker\"},{\"text\":\"使用 Ansible 工具批量操作虚拟机集群，自动化安装 Docker\",\"link\":\"/blog/docker/ansible-and-docker\"}]},{\"text\":\"镜像操作\",\"collapsed\":false,\"items\":[{\"text\":\"分享一个给 Django 镜像瘦身 50% 的经验\",\"link\":\"/blog/docker/docker-image-for-django\"},{\"text\":\"Dockerfile 中的 multi-stage 特性，Vue 项目多阶段构建实战\",\"link\":\"/blog/docker/dockerfile-multi-stage\"}]}],\"/blog/free/\":[{\"text\":\"无分类文章\",\"collapsed\":false,\"items\":[]}],\"/blog/git/\":[{\"text\":\"Git操作\",\"collapsed\":false,\"items\":[{\"text\":\"Git 提交信息规范与最佳实践\",\"link\":\"/blog/git/git-commit\"},{\"text\":\"Git 常用及特殊命令笔记\",\"link\":\"/blog/git/git-note\"}]}],\"/blog/linux/\":[],\"/blog/nginx/\":[{\"text\":\"Nginx配置学习\",\"collapsed\":false,\"items\":[{\"text\":\"Nginx配置中server模块的加载顺序和规则\",\"link\":\"/blog/nginx/nginx-server\"},{\"text\":\"终于理解了Nginx配置中location规则的优先级问题\",\"link\":\"/blog/nginx/nginx-location\"}]}],\"/blog/personal-notes/\":[],\"/blog/python/\":[{\"text\":\"实战经验\",\"collapsed\":false,\"items\":[{\"text\":\"Python 虚拟环境 Virtualenv 分别在 Windows 和 Linux 上的安装和使用\",\"link\":\"/blog/python/virtualenv-for-python\"}]},{\"text\":\"自动化测试\",\"collapsed\":false,\"items\":[{\"text\":\"【Appium 自动化测试】搭建 Appium 环境踩坑记录\",\"link\":\"/blog/python/appium-env\"}]}],\"/blog/Redis/\":[{\"text\":\"安装部署\",\"collapsed\":false,\"items\":[{\"text\":\"Redis哨兵模式部署\",\"link\":\"/blog/Redis/redis-install-sentinel\"},{\"text\":\"Redis单机部署\",\"link\":\"/blog/Redis/redis-install\"}]}]},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/ctbloge/ctbloge.github.io\"}]},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>